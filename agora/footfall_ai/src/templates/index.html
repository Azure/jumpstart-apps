<!DOCTYPE html>

<head>
    <title>Person count demo</title>
    <style>
        .container {
            position: relative;
            width: 640px;
            height: 480px;
        }

        #webCamera {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #videoCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<h1>Person count demo</h1>
<form method="post" action="/inference" onsubmit="submitAction();">

    <h2>
        Source
    </h2>
    <input type="text" placeholder="Enter the URL of the RTSP video stream" value="" name="txtVideoSource"
        id="txtVideoSource" style="width:700px" onblur="changeVideoURL();" />
    <p>
        <label>OR, select from the following list</label>
    </p>
    <select id="videoSource" name="videoSource" onchange="changeVideoSelection();">
        <option value="rtsp://rtsp_stream_container:554/stream">rtsp://rtsp_stream_container:554/stream</option>
    </select>
    <input type="text" id="txtX1" name="txtX1" style="display: none;" />
    <input type="text" id="txtY1" name="txtY1" style="display: none;" />
    <input type="text" id="txtX2" name="txtX2" style="display: none;" />
    <input type="text" id="txtY2" name="txtY2" style="display: none;" />
    <h2>
        Selected Video
    </h2>
    <table>
        <tr>
            <td>
                <div class="container">
                    <img id="webCamera" style="width: 640; height: 360;" src="{{ url_for('video_feed') }}?source=" alt="Web Camera Feed">
                    <canvas id="videoCanvas"></canvas>
                </div>
            </td>
        </tr>
    </table>
</form>

<script>
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    const webCamera = document.getElementById('webCamera');
    const videoSource = document.getElementById('videoSource');

    let isDrawing = false;
    let startX, startY, width, height;

    // Set canvas size to match the container
    canvas.width = 640;
    canvas.height = 360;

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', drawRectangle);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    function startDrawing(e) {
        isDrawing = true;
        [startX, startY] = [e.offsetX, e.offsetY];
    }

    function drawRectangle(e) {
        if (!isDrawing) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous drawing

        width = e.offsetX - startX;
        height = e.offsetY - startY;

        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, width, height);
    }

    function stopDrawing() {
        if (isDrawing) {
            isDrawing = false;
            updateWebCameraSource();
        }
    }

    function updateWebCameraSource() {
        const selectedSource = videoSource.value;

        // Show loader
        const loader = document.createElement('div');
        loader.id = 'loader';
        loader.style.position = 'absolute';
        loader.style.top = '50%';
        loader.style.left = '50%';
        loader.style.transform = 'translate(-50%, -50%)';
        loader.style.border = '16px solid #f3f3f3';
        loader.style.borderRadius = '50%';
        loader.style.borderTop = '16px solid #3498db';
        loader.style.width = '120px';
        loader.style.height = '120px';
        loader.style.animation = 'spin 10s linear infinite';
        document.body.appendChild(loader);

        // Remove canvas drawing
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Remove loader after 3 seconds (or when the video feed is ready)
        setTimeout(() => {
            document.body.removeChild(loader);
        }, 3000);

        // CSS for loader animation
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        // Update the src attribute with rectangle coordinates and video source
        webCamera.src = `{{ url_for('video_feed') }}?x=${startX}&y=${startY}&w=${width}&h=${height}&source=${selectedSource}`;
    }

    // Update source when video source changes
    videoSource.addEventListener('change', updateWebCameraSource);
</script>